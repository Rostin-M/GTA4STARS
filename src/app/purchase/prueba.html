import { Component, OnInit } from '@angular/core';

@Component({
    selector: 'app-purchase',
    templateUrl: './purchase.component.html',
    styleUrls: ['./purchase.component.css']
})
export class PurchaseComponent implements OnInit {

    ngOnInit(): void {
        this.simulateLoading();

        // Iniciar la simulación de carga cuando se carga el componente
        window.addEventListener('load', () => {
            this.simulateLoading();
        });

        // Configurar eventos
        const proceedToPaymentButton = document.getElementById('proceedToPayment');
        if (proceedToPaymentButton) {
            proceedToPaymentButton.addEventListener('click', () => this.proceedToPayment());
        }

        const payButton = document.getElementById('payButton');
        if (payButton) {
            payButton.addEventListener('click', () => this.processPayment());
        }

        const downloadReceiptButton = document.getElementById('downloadReceipt');
        if (downloadReceiptButton) {
            downloadReceiptButton.addEventListener('click', () => this.downloadReceipt());
        }

        const paymentMethods = document.querySelectorAll('.payment-method');
        paymentMethods.forEach(method => {
            method.addEventListener('click', () => this.selectPaymentMethod(method));
        });
    }

    simulateLoading(): void {
        const progress = document.getElementById('progress') as HTMLElement;
        const loadingScreen = document.getElementById('loadingScreen') as HTMLElement;
        let width = 0;

        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    if (loadingScreen) loadingScreen.style.display = 'none';
                }, 500);
            } else {
                width += Math.random() * 10;
                if (width > 100) width = 100;
                if (progress) progress.style.width = width + '%';
            }
        }, 200);
    }

    proceedToPayment(): void {
        const paymentForm = document.getElementById('paymentForm') as HTMLElement;
        const proceedToPaymentButton = document.getElementById('proceedToPayment') as HTMLElement;

        if (paymentForm && proceedToPaymentButton) {
            paymentForm.style.display = 'block';
            proceedToPaymentButton.style.display = 'none';
            window.scrollTo({
                top: paymentForm.offsetTop - 20,
                behavior: 'smooth'
            });
        }
    }

    selectPaymentMethod(method: Element): void {
        const paymentMethods = document.querySelectorAll('.payment-method');
        paymentMethods.forEach(m => m.classList.remove('active'));
        method.classList.add('active');
    }

    processPayment(): void {
        const cardName = (document.getElementById('cardName') as HTMLInputElement).value;
        const cardNumber = (document.getElementById('cardNumber') as HTMLInputElement).value;
        const expiryDate = (document.getElementById('expiryDate') as HTMLInputElement).value;
        const cvv = (document.getElementById('cvv') as HTMLInputElement).value;

        if (!cardName || !cardNumber || !expiryDate || !cvv) {
            alert('Por favor completa todos los campos');
            return;
        }

        const loadingScreen = document.getElementById('loadingScreen') as HTMLElement;
        const loadingText = document.querySelector('.loading-text') as HTMLElement;

        if (loadingScreen && loadingText) {
            loadingText.innerHTML = '<p>Procesando tu pago</p><p>Por favor espera...</p>';
            loadingScreen.style.display = 'flex';
        }

        const progress = document.getElementById('progress') as HTMLElement;
        let width = 0;

        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    if (loadingScreen) loadingScreen.style.display = 'none';
                    const paymentForm = document.getElementById('paymentForm') as HTMLElement;
                    const paymentConfirmation = document.getElementById('paymentConfirmation') as HTMLElement;

                    if (paymentForm && paymentConfirmation) {
                        paymentForm.style.display = 'none';
                        paymentConfirmation.style.display = 'block';

                        const now = new Date();
                        const transactionDate = document.getElementById('transactionDate') as HTMLElement;
                        if (transactionDate) transactionDate.textContent = now.toLocaleString();

                        window.scrollTo({
                            top: paymentConfirmation.offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }
                }, 500);
            } else {
                width += Math.random() * 8;
                if (width > 100) width = 100;
                if (progress) progress.style.width = width + '%';
            }
        }, 200);
    }

    downloadReceipt(): void {
        const transactionDate = (document.getElementById('transactionDate') as HTMLElement).textContent;

        const receiptContent = `
            COMPROBANTE DE PAGO - SIMULACIÓN DEMO
            =====================================
            
            ID de Transacción: DEMO-12345-67890
            Fecha: ${transactionDate}
            Método de Pago: Tarjeta terminada en XXXX
            Monto: $109.98
            
            =====================================
            Este es un comprobante de simulación.
            No representa una transacción real.
        `;

        const blob = new Blob([receiptContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'comprobante_pago_demo.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}
